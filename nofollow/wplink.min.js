var wpLink;!function(a){function j(){return b.dom.getParent(b.selection.getNode(),"a")}var b,c,d,e,f,g={},h={},i="ontouchend"in document;wpLink={timeToTriggerRiver:150,minRiverAJAXDuration:200,riverBottomThreshold:5,keySensitivity:100,lastSearch:"",textarea:"",append:function(){var b='<br /><label><span> </span><input type="checkbox" id="link-nofollow-checkbox" /> Add <code>rel="nofollow"</code> to link</label>';a("#wp-link .link-target").append(b)},init:function(){function b(){var b=a.trim(g.url.val());b&&f!==b&&!/^(?:[a-z]+:|#|\?|\.|\/)/.test(b)&&(g.url.val("http://"+b),f=b)}g.wrap=a("#wp-link-wrap"),g.dialog=a("#wp-link"),g.backdrop=a("#wp-link-backdrop"),g.submit=a("#wp-link-submit"),g.close=a("#wp-link-close"),g.text=a("#wp-link-text"),g.url=a("#wp-link-url"),g.nonce=a("#_ajax_linking_nonce"),g.openInNewTab=a("#wp-link-target"),g.relNofollow=a("#link-nofollow-checkbox"),g.search=a("#wp-link-search"),h.search=new d(a("#search-results")),h.recent=new d(a("#most-recent-results")),h.elements=g.dialog.find(".query-results"),g.queryNotice=a("#query-notice-message"),g.queryNoticeTextDefault=g.queryNotice.find(".query-notice-default"),g.queryNoticeTextHint=g.queryNotice.find(".query-notice-hint"),g.dialog.keydown(wpLink.keydown),g.dialog.keyup(wpLink.keyup),g.submit.click(function(a){a.preventDefault(),wpLink.update()}),g.close.add(g.backdrop).add("#wp-link-cancel a").click(function(a){a.preventDefault(),wpLink.close()}),a("#wp-link-search-toggle").on("click",wpLink.toggleInternalLinking),h.elements.on("river-select",wpLink.updateFields),g.search.on("focus.wplink",function(){g.queryNoticeTextDefault.hide(),g.queryNoticeTextHint.removeClass("screen-reader-text").show()}).on("blur.wplink",function(){g.queryNoticeTextDefault.show(),g.queryNoticeTextHint.addClass("screen-reader-text").hide()}),g.search.keyup(function(){var a=this;window.clearTimeout(c),c=window.setTimeout(function(){wpLink.searchInternalLinks.call(a)},500)}),g.url.on("paste",function(){setTimeout(b,0)}),g.url.on("blur",b)},open:function(c){var d;a(document.body).addClass("modal-open"),wpLink.range=null,c&&(window.wpActiveEditor=c),window.wpActiveEditor&&(this.textarea=a("#"+window.wpActiveEditor).get(0),"undefined"!=typeof tinymce&&(d=tinymce.get(wpActiveEditor),b=d&&!d.isHidden()?d:null,b&&tinymce.isIE&&(b.windowManager.bookmark=b.selection.getBookmark())),!wpLink.isMCE()&&document.selection&&(this.textarea.focus(),this.range=document.selection.createRange()),g.wrap.show(),g.backdrop.show(),wpLink.refresh(),a(document).trigger("wplink-open",g.wrap))},isMCE:function(){return b&&!b.isHidden()},refresh:function(){var a="";h.search.refresh(),h.recent.refresh(),wpLink.isMCE()?wpLink.mceRefresh():(g.wrap.hasClass("has-text-field")||g.wrap.addClass("has-text-field"),document.selection?a=document.selection.createRange().text||"":"undefined"!=typeof this.textarea.selectionStart&&this.textarea.selectionStart!==this.textarea.selectionEnd&&(a=this.textarea.value.substring(this.textarea.selectionStart,this.textarea.selectionEnd)||""),g.text.val(a),wpLink.setDefaultValues()),i?g.url.focus().blur():g.url.focus()[0].select(),h.recent.ul.children().length||h.recent.ajax(),f=g.url.val().replace(/^http:\/\//,"")},hasSelectedText:function(a){var c=b.selection.getContent();if(/</.test(c)&&(!/^<a [^>]+>[^<]+<\/a>$/.test(c)||-1===c.indexOf("href=")))return!1;if(a){var e,d=a.childNodes;if(0===d.length)return!1;for(e=d.length-1;e>=0;e--)if(3!=d[e].nodeType)return!1}return!0},mceRefresh:function(){var a,c=b.selection.getNode(),d=b.dom.getParent(c,"a[href]"),e=this.hasSelectedText(d);d?(a=d.innerText||d.textContent,g.url.val(b.dom.getAttrib(d,"href")),g.openInNewTab.prop("checked","_blank"===b.dom.getAttrib(d,"target")),"nofollow"==b.dom.getAttrib(d,"rel")?g.relNofollow.prop("checked",!0):g.relNofollow.prop("checked",!1),g.submit.val(wpLinkL10n.update)):(a=b.selection.getContent({format:"text"}),this.setDefaultValues()),e?(g.text.val(a||""),g.wrap.addClass("has-text-field")):(g.text.val(""),g.wrap.removeClass("has-text-field"))},close:function(){a(document.body).removeClass("modal-open"),wpLink.isMCE()?b.focus():(wpLink.textarea.focus(),wpLink.range&&(wpLink.range.moveToBookmark(wpLink.range.getBookmark()),wpLink.range.select())),g.backdrop.hide(),g.wrap.hide(),f=!1,a(document).trigger("wplink-close",g.wrap)},getAttrs:function(){return{href:a.trim(g.url.val()),target:g.openInNewTab.prop("checked")?"_blank":"",rel:g.relNofollow.prop("checked")?"nofollow":""}},update:function(){wpLink.isMCE()?wpLink.mceUpdate():wpLink.htmlUpdate()},htmlUpdate:function(){var a,b,c,d,e,f,h,i=wpLink.textarea;i&&(a=wpLink.getAttrs(),b=g.text.val(),a.href&&(c='<a href="'+a.href+'"',a.target&&(c+=' target="'+a.target+'"'),a.rel&&(c+=' rel="'+a.rel+'"'),c+=">",document.selection&&wpLink.range?(i.focus(),wpLink.range.text=c+(b||wpLink.range.text)+"</a>",wpLink.range.moveToBookmark(wpLink.range.getBookmark()),wpLink.range.select(),wpLink.range=null):"undefined"!=typeof i.selectionStart&&(d=i.selectionStart,e=i.selectionEnd,h=b||i.value.substring(d,e),c=c+h+"</a>",f=d+c.length,d!==e||h||(f-=4),i.value=i.value.substring(0,d)+c+i.value.substring(e,i.value.length),i.selectionStart=i.selectionEnd=f),wpLink.close(),i.focus()))},mceUpdate:function(){var c,d,a=wpLink.getAttrs();return wpLink.close(),b.focus(),tinymce.isIE&&b.selection.moveToBookmark(b.windowManager.bookmark),a.href?(c=j(),d=g.text.val(),void(c?(d&&("innerText"in c?c.innerText=d:c.textContent=d),b.dom.setAttribs(c,a)):d?b.selection.setNode(b.dom.create("a",a,d)):b.execCommand("mceInsertLink",!1,a))):void b.execCommand("unlink")},updateFields:function(a,b){g.url.val(b.children(".item-permalink").val())},setDefaultValues:function(){var a,c=/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,4}$/i,d=/^(https?|ftp):\/\/[A-Z0-9.-]+\.[A-Z]{2,4}[^ "]*$/i;this.isMCE()?a=b.selection.getContent():document.selection&&wpLink.range?a=wpLink.range.text:"undefined"!=typeof this.textarea.selectionStart&&(a=this.textarea.value.substring(this.textarea.selectionStart,this.textarea.selectionEnd)),a&&c.test(a)?g.url.val("mailto:"+a):a&&d.test(a)?g.url.val(a.replace(/&amp;|&#0?38;/gi,"&")):g.url.val(""),g.submit.val(wpLinkL10n.save)},searchInternalLinks:function(){var c,b=a(this),d=b.val();if(d.length>2){if(h.recent.hide(),h.search.show(),wpLink.lastSearch==d)return;wpLink.lastSearch=d,c=b.parent().find(".spinner").addClass("is-active"),h.search.change(d),h.search.ajax(function(){c.removeClass("is-active")})}else h.search.hide(),h.recent.show()},next:function(){h.search.next(),h.recent.next()},prev:function(){h.search.prev(),h.recent.prev()},keydown:function(b){var c,d,e=a.ui.keyCode;e.ESCAPE===b.keyCode?(wpLink.close(),b.stopImmediatePropagation()):e.TAB===b.keyCode&&(d=b.target.id,"wp-link-submit"!==d||b.shiftKey?"wp-link-close"===d&&b.shiftKey&&(g.submit.focus(),b.preventDefault()):(g.close.focus(),b.preventDefault())),(b.keyCode===e.UP||b.keyCode===e.DOWN)&&(!document.activeElement||"link-title-field"!==document.activeElement.id&&"url-field"!==document.activeElement.id)&&(c=b.keyCode===e.UP?"prev":"next",clearInterval(wpLink.keyInterval),wpLink[c](),wpLink.keyInterval=setInterval(wpLink[c],wpLink.keySensitivity),b.preventDefault())},keyup:function(b){var c=a.ui.keyCode;(b.which===c.UP||b.which===c.DOWN)&&(clearInterval(wpLink.keyInterval),b.preventDefault())},delayedCallback:function(a,b){var c,d,e,f;return b?(setTimeout(function(){return d?a.apply(f,e):void(c=!0)},b),function(){return c?a.apply(this,arguments):(e=arguments,f=this,void(d=!0))}):a},toggleInternalLinking:function(a){var b=g.wrap.hasClass("search-panel-visible");g.wrap.toggleClass("search-panel-visible",!b),setUserSetting("wplink",b?"0":"1"),g[b?"url":"search"].focus(),a.preventDefault()}},d=function(b,c){var d=this;this.element=b,this.ul=b.children("ul"),this.contentHeight=b.children("#link-selector-height"),this.waiting=b.find(".river-waiting"),this.change(c),this.refresh(),a("#wp-link .query-results, #wp-link #link-selector").scroll(function(){d.maybeLoad()}),b.on("click","li",function(b){d.select(a(this),b)})},a.extend(d.prototype,{refresh:function(){this.deselect(),this.visible=this.element.is(":visible")},show:function(){this.visible||(this.deselect(),this.element.show(),this.visible=!0)},hide:function(){this.element.hide(),this.visible=!1},select:function(a,b){var c,d,e,f;a.hasClass("unselectable")||a==this.selected||(this.deselect(),this.selected=a.addClass("selected"),c=a.outerHeight(),d=this.element.height(),e=a.position().top,f=this.element.scrollTop(),0>e?this.element.scrollTop(f+e):e+c>d&&this.element.scrollTop(f+e-d+c),this.element.trigger("river-select",[a,b,this]))},deselect:function(){this.selected&&this.selected.removeClass("selected"),this.selected=!1},prev:function(){if(this.visible){var a;this.selected&&(a=this.selected.prev("li"),a.length&&this.select(a))}},next:function(){if(this.visible){var b=this.selected?this.selected.next("li"):a("li:not(.unselectable):first",this.element);b.length&&this.select(b)}},ajax:function(a){var b=this,c=1==this.query.page?0:wpLink.minRiverAJAXDuration,d=wpLink.delayedCallback(function(c,d){b.process(c,d),a&&a(c,d)},c);this.query.ajax(d)},change:function(a){this.query&&this._search==a||(this._search=a,this.query=new e(a),this.element.scrollTop(0))},process:function(b,c){var d="",e=!0,f="",g=1==c.page;b?a.each(b,function(){f=e?"alternate":"",f+=this.title?"":" no-title",d+=f?'<li class="'+f+'">':"<li>",d+='<input type="hidden" class="item-permalink" value="'+this.permalink+'" />',d+='<span class="item-title">',d+=this.title?this.title:wpLinkL10n.noTitle,d+='</span><span class="item-info">'+this.info+"</span></li>",e=!e}):g&&(d+='<li class="unselectable no-matches-found"><span class="item-title"><em>'+wpLinkL10n.noMatchesFound+"</em></span></li>"),this.ul[g?"html":"append"](d)},maybeLoad:function(){var a=this,b=this.element,c=b.scrollTop()+b.height();!this.query.ready()||c<this.contentHeight.height()-wpLink.riverBottomThreshold||setTimeout(function(){var c=b.scrollTop(),d=c+b.height();!a.query.ready()||d<a.contentHeight.height()-wpLink.riverBottomThreshold||(a.waiting.addClass("is-active"),b.scrollTop(c+a.waiting.outerHeight()),a.ajax(function(){a.waiting.removeClass("is-active")}))},wpLink.timeToTriggerRiver)}}),e=function(a){this.page=1,this.allLoaded=!1,this.querying=!1,this.search=a},a.extend(e.prototype,{ready:function(){return!(this.querying||this.allLoaded)},ajax:function(b){var c=this,d={action:"wp-link-ajax",page:this.page,_ajax_linking_nonce:g.nonce.val()};this.search&&(d.search=this.search),this.querying=!0,a.post(ajaxurl,d,function(a){c.page++,c.querying=!1,c.allLoaded=!a,b(a,d)},"json")}}),a(document).ready(wpLink.append),a(document).ready(wpLink.init)}(jQuery);